<!DOCTYPE html><html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charge Navigator Pro</title>
    <!-- Leaflet (unica inclusione) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
        --primary: #00dc82; --secondary: #1a1a2e; --accent: #0f4c81; --danger: #ff4757;
        --warning: #ffa502; --success: #00dc82; --dark: #0f0f1e; --light: #f5f7fa;
        --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%); color: #333; min-height: 100vh; }
    .app-container { display: flex; height: 100vh; background: #f5f7fa; }
    /* Sidebar */
    .sidebar { width: 400px; background: white; box-shadow: 2px 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
    .sidebar-header { background: linear-gradient(135deg, #00dc82 0%, #0f4c81 100%); color: white; padding: 20px; text-align: center; }
    .logo { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
    /* Form Elements */
    .form-group { margin-bottom: 20px; }
    label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
    input, select { width: 100%; padding: 12px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
    input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 220, 130, 0.1); }
    /* Battery */
    .battery-section { background: linear-gradient(135deg, #f5f7fa 0%, #e0e6ed 100%); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
    .battery-display { display: flex; align-items: center; gap: 15px; margin: 10px 0; }
    .battery-visual { flex: 1; height: 40px; background: white; border: 3px solid #333; border-radius: 8px; position: relative; overflow: hidden; }
    .battery-fill { height: 100%; background: linear-gradient(90deg, #00dc82, #00a86b); transition: width 0.3s ease; }
    .battery-percentage { font-size: 28px; font-weight: bold; color: #333; min-width: 70px; }
    .battery-slider { width: 100%; margin-top: 10px; }
    /* Search Autocomplete */
    .search-container { position: relative; }
    .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e6ed; border-radius: 0 0 8px 8px; max-height: 240px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .search-suggestions.active { display: block; }
    .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .suggestion-item:hover { background: #f5f7fa; }
    .suggestion-item b{font-weight:700}
    .suggestion-item.active{background:#eef6ff}
    .suggestion-meta{font-size:12px;color:#777}
    /* Buttons */
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; margin-top: 10px; }
    .btn-primary { background: linear-gradient(135deg, #00dc82 0%, #00a86b 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 220, 130, 0.4); }
    .btn-secondary { background: white; color: #333; border: 2px solid #e0e6ed; }
    .btn-secondary:hover { background: #f5f7fa; }
    /* Map */
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    /* Route Info */
    .route-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 20px; margin-top: 20px; display: none; }
    .route-info.active { display: block; }
    .route-stat { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
    .route-stat:last-child { border: none; }
    /* Station Cards */
    .station-list { margin-top: 20px; }
    .station-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s; }
    .station-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .station-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .station-name { font-weight: 600; color: #333; }
    .station-type { background: var(--primary); color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; }
    .station-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px; color: #666; }
    /* Loading */
    .loading { text-align: center; padding: 40px; display: none; }
    .loading.active { display: block; }
    .spinner { width: 50px; height: 50px; border: 4px solid #f0f0f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* Responsive */
    @media (max-width: 768px) { .app-container { flex-direction: column; } .sidebar { width: 100%; height: 50vh; } }
</style>

</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">‚ö° EV Charge Navigator Pro</div>
                <div style="font-size: 12px; opacity: 0.9;">Trova la ricarica perfetta per il tuo viaggio</div>
            </div>
            <div class="sidebar-content">
                <div class="form-group">
                    <label for="carSelect">Seleziona la tua auto elettrica</label>
                    <input type="text" id="carSearch" placeholder="Cerca il tuo modello..." oninput="searchCar(this.value)">
                    <select id="carSelect" onchange="updateBatteryInfo()">
                        <option value="">-- Seleziona veicolo --</option>
                    </select>
                </div><div class="battery-section">
                <label>Stato batteria attuale</label>
                <div class="battery-display">
                    <div class="battery-visual">
                        <div class="battery-fill" id="batteryFill" style="width: 80%"></div>
                    </div>
                    <div class="battery-percentage" id="batteryPercentage">80%</div>
                </div>
                <input type="range" id="batterySlider" class="battery-slider" min="5" max="100" value="80" oninput="updateBattery(this.value)">
                <div id="batteryRange" style="margin-top: 10px; font-size: 14px; color: #666;">
                    Autonomia: <strong id="rangeValue">320 km</strong>
                </div>
            </div>

            <div class="form-group search-container">
                <label for="startLocation">Punto di partenza</label>
                <input type="text" id="startLocation" autocomplete="off" data-type="start" placeholder="Inserisci citt√† o indirizzo..." oninput="searchLocation(this.value, 'start')" onkeydown="navSuggestions(event, 'start')">
                <div class="search-suggestions" id="startSuggestions"></div>
                <button class="btn btn-secondary" onclick="useGPS()">üìç Usa posizione GPS</button>
            </div>

            <div class="form-group search-container">
                <label for="endLocation">Destinazione</label>
                <input type="text" id="endLocation" autocomplete="off" data-type="end" placeholder="Inserisci citt√† o indirizzo..." oninput="searchLocation(this.value, 'end')" onkeydown="navSuggestions(event, 'end')">
                <div class="search-suggestions" id="endSuggestions"></div>
            </div>

            <button class="btn btn-primary" onclick="calculateRoute()">üîç Calcola percorso ottimale</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;">Calcolo percorso in corso...</p>
            </div>

            <div class="route-info" id="routeInfo">
                <h3 style="margin-bottom: 15px;">Percorso ottimizzato</h3>
                <div class="route-stat"><span>Distanza totale:</span><strong id="totalDistance">--</strong></div>
                <div class="route-stat"><span>Tempo di viaggio:</span><strong id="travelTime">--</strong></div>
                <div class="route-stat"><span>Soste ricarica:</span><strong id="chargingStops">--</strong></div>
                <div class="route-stat"><span>Costo stimato:</span><strong id="estimatedCost">--</strong></div>
            </div>

            <div class="station-list" id="stationList"></div>
        </div>
    </div>
    <div class="map-container"><div id="map"></div></div>
</div>

<script>
    // ===== Database completo veicoli elettrici (come il tuo, invariato) =====
    const vehicles = {
        'Tesla Model 3 SR+': { battery: 50, range: 420, consumption: 14 },
        'Tesla Model 3 Long Range': { battery: 75, range: 580, consumption: 15 },
        'Tesla Model 3 Performance': { battery: 75, range: 547, consumption: 16 },
        'Tesla Model Y SR': { battery: 60, range: 455, consumption: 15 },
        'Tesla Model Y Long Range': { battery: 75, range: 533, consumption: 16 },
        'Tesla Model Y Performance': { battery: 75, range: 514, consumption: 17 },
        'Tesla Model S Long Range': { battery: 100, range: 652, consumption: 18 },
        'Tesla Model S Plaid': { battery: 100, range: 637, consumption: 19 },
        'Tesla Model X Long Range': { battery: 100, range: 580, consumption: 20 },
        'Tesla Model X Plaid': { battery: 100, range: 547, consumption: 21 },
        'Tesla Cybertruck': { battery: 123, range: 500, consumption: 25 },
        'VW ID.3 Pure': { battery: 45, range: 330, consumption: 14 },
        'VW ID.3 Pro': { battery: 58, range: 420, consumption: 14 },
        'VW ID.3 Pro S': { battery: 77, range: 550, consumption: 14 },
        'VW ID.4 Pro': { battery: 77, range: 520, consumption: 17 },
        'VW ID.4 GTX': { battery: 77, range: 480, consumption: 18 },
        'VW ID.5': { battery: 77, range: 520, consumption: 17 },
        'VW ID.7': { battery: 77, range: 615, consumption: 14 },
        'VW ID.Buzz': { battery: 77, range: 420, consumption: 20 },
        'Audi Q4 e-tron 35': { battery: 52, range: 341, consumption: 16 },
        'Audi Q4 e-tron 40': { battery: 77, range: 520, consumption: 17 },
        'Audi Q4 e-tron 50': { battery: 77, range: 488, consumption: 18 },
        'Audi Q6 e-tron': { battery: 100, range: 600, consumption: 18 },
        'Audi Q8 e-tron 55': { battery: 106, range: 582, consumption: 20 },
        'Audi e-tron GT': { battery: 86, range: 488, consumption: 19 },
        'Audi RS e-tron GT': { battery: 86, range: 472, consumption: 20 },
        'Porsche Taycan': { battery: 79, range: 431, consumption: 20 },
        'Porsche Taycan 4S': { battery: 79, range: 407, consumption: 21 },
        'Porsche Taycan Turbo': { battery: 93, range: 450, consumption: 22 },
        'Porsche Taycan Turbo S': { battery: 93, range: 412, consumption: 23 },
        'Porsche Macan Electric': { battery: 100, range: 500, consumption: 19 },
        'Skoda Enyaq iV 60': { battery: 58, range: 390, consumption: 16 },
        'Skoda Enyaq iV 80': { battery: 77, range: 510, consumption: 17 },
        'Skoda Enyaq RS': { battery: 77, range: 460, consumption: 18 },
        'Cupra Born 58': { battery: 58, range: 420, consumption: 14 },
        'Cupra Born 77': { battery: 77, range: 540, consumption: 15 },
        'Seat Mii Electric': { battery: 32, range: 260, consumption: 12 },
        'BMW i3': { battery: 42, range: 285, consumption: 13 },
        'BMW i4 eDrive35': { battery: 67, range: 483, consumption: 16 },
        'BMW i4 eDrive40': { battery: 80, range: 590, consumption: 16 },
        'BMW i4 M50': { battery: 80, range: 510, consumption: 18 },
        'BMW i5 eDrive40': { battery: 81, range: 582, consumption: 17 },
        'BMW i5 M60': { battery: 81, range: 516, consumption: 19 },
        'BMW i7 xDrive60': { battery: 101, range: 625, consumption: 18 },
        'BMW i7 M70': { battery: 101, range: 560, consumption: 20 },
        'BMW iX1 xDrive30': { battery: 64, range: 440, consumption: 17 },
        'BMW iX2 xDrive30': { battery: 64, range: 449, consumption: 16 },
        'BMW iX3': { battery: 74, range: 460, consumption: 17 },
        'BMW iX xDrive40': { battery: 71, range: 425, consumption: 19 },
        'BMW iX xDrive50': { battery: 105, range: 630, consumption: 19 },
        'BMW iX M60': { battery: 105, range: 566, consumption: 21 },
        'MINI Cooper SE': { battery: 32, range: 234, consumption: 14 },
        'MINI Countryman SE': { battery: 66, range: 433, consumption: 17 },
        'Rolls-Royce Spectre': { battery: 102, range: 530, consumption: 22 },
        'Mercedes EQA 250': { battery: 66, range: 426, consumption: 17 },
        'Mercedes EQA 300': { battery: 66, range: 426, consumption: 17 },
        'Mercedes EQA 350': { battery: 66, range: 411, consumption: 18 },
        'Mercedes EQB 250': { battery: 66, range: 419, consumption: 18 },
        'Mercedes EQB 300': { battery: 66, range: 423, consumption: 18 },
        'Mercedes EQB 350': { battery: 66, range: 423, consumption: 19 },
        'Mercedes EQC 400': { battery: 80, range: 417, consumption: 22 },
        'Mercedes EQE 300': { battery: 89, range: 639, consumption: 16 },
        'Mercedes EQE 350+': { battery: 96, range: 669, consumption: 16 },
        'Mercedes EQE 500': { battery: 96, range: 623, consumption: 17 },
        'Mercedes EQE AMG 43': { battery: 96, range: 533, consumption: 18 },
        'Mercedes EQE AMG 53': { battery: 96, range: 518, consumption: 19 },
        'Mercedes EQS 450+': { battery: 107, range: 784, consumption: 17 },
        'Mercedes EQS 500': { battery: 107, range: 729, consumption: 18 },
        'Mercedes EQS 580': { battery: 107, range: 676, consumption: 19 },
        'Mercedes EQS AMG 53': { battery: 107, range: 586, consumption: 20 },
        'Mercedes EQV 300': { battery: 90, range: 363, consumption: 26 },
        'Mercedes G 580 EQ': { battery: 116, range: 473, consumption: 27 },
        'Smart #1': { battery: 66, range: 440, consumption: 16 },
        'Smart #3': { battery: 66, range: 455, consumption: 17 },
        'Fiat 500e (24 kWh)': { battery: 24, range: 190, consumption: 13 },
        'Fiat 500e (42 kWh)': { battery: 42, range: 320, consumption: 13 },
        'Fiat 600e': { battery: 54, range: 400, consumption: 15 },
        'Fiat Topolino': { battery: 5.5, range: 75, consumption: 7 },
        'Abarth 500e': { battery: 42, range: 285, consumption: 14 },
        'Peugeot e-208': { battery: 50, range: 362, consumption: 14 },
        'Peugeot e-2008': { battery: 50, range: 342, consumption: 16 },
        'Peugeot e-308': { battery: 54, range: 400, consumption: 15 },
        'Peugeot e-3008': { battery: 73, range: 525, consumption: 17 },
        'Peugeot e-5008': { battery: 73, range: 500, consumption: 19 },
        'Peugeot e-Rifter': { battery: 50, range: 280, consumption: 18 },
        'Peugeot e-Traveller': { battery: 75, range: 330, consumption: 25 },
        'Peugeot e-Expert': { battery: 75, range: 330, consumption: 25 },
        'Citroen Ami': { battery: 5.5, range: 75, consumption: 7 },
        'Citroen e-C3': { battery: 44, range: 320, consumption: 14 },
        'Citroen e-C4': { battery: 50, range: 350, consumption: 15 },
        'Citroen e-C4 X': { battery: 50, range: 360, consumption: 15 },
        'Citroen e-Berlingo': { battery: 50, range: 280, consumption: 19 },
        'Citroen e-SpaceTourer': { battery: 75, range: 330, consumption: 25 },
        'Citroen e-Jumpy': { battery: 75, range: 330, consumption: 25 },
        'Opel Corsa-e': { battery: 50, range: 357, consumption: 14 },
        'Opel Mokka-e': { battery: 50, range: 338, consumption: 16 },
        'Opel Astra Electric': { battery: 54, range: 416, consumption: 15 },
        'Opel Combo-e': { battery: 50, range: 280, consumption: 19 },
        'Opel Zafira-e': { battery: 75, range: 330, consumption: 25 },
        'Opel Vivaro-e': { battery: 75, range: 330, consumption: 25 },
        'DS 3 Crossback E-Tense': { battery: 50, range: 341, consumption: 15 },
        'DS 4 E-Tense': { battery: 12, range: 50, consumption: 24 },
        'Jeep Avenger': { battery: 54, range: 400, consumption: 15 },
        'Jeep Wagoneer S': { battery: 100, range: 500, consumption: 22 },
        'Alfa Romeo Junior Elettrica': { battery: 54, range: 410, consumption: 15 },
        'Lancia Ypsilon Elettrica': { battery: 51, range: 403, consumption: 14 },
        'Maserati GranTurismo Folgore': { battery: 92, range: 450, consumption: 22 },
        'Maserati Grecale Folgore': { battery: 105, range: 500, consumption: 20 },
        'RAM 1500 REV': { battery: 168, range: 560, consumption: 30 },
        'Renault 5 E-Tech': { battery: 52, range: 400, consumption: 14 },
        'Renault Twingo E-Tech': { battery: 22, range: 190, consumption: 12 },
        'Renault Zoe': { battery: 52, range: 395, consumption: 13 },
        'Renault Megane E-Tech': { battery: 60, range: 470, consumption: 15 },
        'Renault Scenic E-Tech': { battery: 87, range: 625, consumption: 17 },
        'Renault Kangoo E-Tech': { battery: 45, range: 285, consumption: 18 },
        'Renault Master E-Tech': { battery: 87, range: 460, consumption: 30 },
        'Dacia Spring': { battery: 27, range: 230, consumption: 12 },
        'Alpine A290': { battery: 52, range: 380, consumption: 15 },
        'Nissan Leaf (40 kWh)': { battery: 40, range: 270, consumption: 15 },
        'Nissan Leaf e+ (62 kWh)': { battery: 62, range: 385, consumption: 16 },
        'Nissan Ariya (63 kWh)': { battery: 63, range: 403, consumption: 16 },
        'Nissan Ariya (87 kWh)': { battery: 87, range: 531, consumption: 17 },
        'Nissan Townstar EV': { battery: 45, range: 285, consumption: 18 },
        'Hyundai Kona Electric (39 kWh)': { battery: 39, range: 305, consumption: 14 },
        'Hyundai Kona Electric (64 kWh)': { battery: 64, range: 484, consumption: 14 },
        'Hyundai Ioniq 5 (58 kWh)': { battery: 58, range: 384, consumption: 16 },
        'Hyundai Ioniq 5 (73 kWh)': { battery: 73, range: 481, consumption: 16 },
        'Hyundai Ioniq 5 (84 kWh)': { battery: 84, range: 570, consumption: 16 },
        'Hyundai Ioniq 5 N': { battery: 84, range: 448, consumption: 21 },
        'Hyundai Ioniq 6 (53 kWh)': { battery: 53, range: 429, consumption: 14 },
        'Hyundai Ioniq 6 (77 kWh)': { battery: 77, range: 614, consumption: 14 },
        'Hyundai Inster': { battery: 42, range: 355, consumption: 13 },
        'Kia EV3': { battery: 58, range: 435, consumption: 14 },
        'Kia EV6 (58 kWh)': { battery: 58, range: 394, consumption: 16 },
        'Kia EV6 (77 kWh)': { battery: 77, range: 528, consumption: 16 },
        'Kia EV6 GT': { battery: 77, range: 424, consumption: 20 },
        'Kia EV9': { battery: 99, range: 541, consumption: 22 },
        'Kia Niro EV': { battery: 64, range: 463, consumption: 15 },
        'Kia Soul EV': { battery: 64, range: 452, consumption: 15 },
        'Genesis GV60': { battery: 77, range: 466, consumption: 17 },
        'Genesis Electrified GV70': { battery: 77, range: 455, consumption: 18 },
        'Genesis Electrified G80': { battery: 87, range: 520, consumption: 19 },
        'Ford Mustang Mach-E Standard': { battery: 70, range: 440, consumption: 18 },
        'Ford Mustang Mach-E Extended': { battery: 91, range: 600, consumption: 18 },
        'Ford Mustang Mach-E GT': { battery: 91, range: 500, consumption: 20 },
        'Ford Explorer Electric': { battery: 77, range: 602, consumption: 17 },
        'Ford Capri Electric': { battery: 77, range: 627, consumption: 16 },
        'Ford F-150 Lightning': { battery: 131, range: 515, consumption: 26 },
        'Ford E-Transit': { battery: 68, range: 317, consumption: 30 },
        'BYD Atto 3': { battery: 60, range: 420, consumption: 16 },
        'BYD Dolphin': { battery: 44, range: 340, consumption: 14 },
        'BYD Seal': { battery: 82, range: 570, consumption: 16 },
        'BYD Seal U': { battery: 87, range: 500, consumption: 18 },
        'BYD Han': { battery: 85, range: 521, consumption: 17 },
        'BYD Tang': { battery: 86, range: 400, consumption: 22 },
        'MG4': { battery: 64, range: 450, consumption: 15 },
        'MG4 XPower': { battery: 64, range: 385, consumption: 17 },
        'MG5': { battery: 61, range: 400, consumption: 16 },
        'MG ZS EV': { battery: 72, range: 440, consumption: 17 },
        'MG Marvel R': { battery: 70, range: 402, consumption: 18 },
        'MG Cyberster': { battery: 77, range: 520, consumption: 17 },
        'NIO ET5': { battery: 75, range: 560, consumption: 16 },
        'NIO ET7': { battery: 100, range: 700, consumption: 18 },
        'NIO EL7': { battery: 100, range: 620, consumption: 20 },
        'XPeng G9': { battery: 98, range: 570, consumption: 19 },
        'XPeng P7': { battery: 86, range: 576, consumption: 16 },
        'Aiways U5': { battery: 63, range: 410, consumption: 16 },
        'ORA Funky Cat': { battery: 48, range: 310, consumption: 15 },
        'ORA Good Cat': { battery: 63, range: 420, consumption: 15 },
        'Hongqi E-HS9': { battery: 120, range: 515, consumption: 24 },
        'Seres 3': { battery: 53, range: 329, consumption: 16 },
        'Lynk & Co 02': { battery: 66, range: 445, consumption: 16 },
        'Volvo EX30': { battery: 51, range: 344, consumption: 15 },
        'Volvo EX40 (XC40 Recharge)': { battery: 78, range: 474, consumption: 18 },
        'Volvo EC40 (C40 Recharge)': { battery: 78, range: 476, consumption: 17 },
        'Volvo EX90': { battery: 107, range: 600, consumption: 20 },
        'Polestar 2 Standard Range': { battery: 69, range: 478, consumption: 16 },
        'Polestar 2 Long Range': { battery: 78, range: 540, consumption: 17 },
        'Polestar 3': { battery: 107, range: 610, consumption: 20 },
        'Polestar 4': { battery: 100, range: 600, consumption: 18 },
        'Lotus Eletre': { battery: 112, range: 600, consumption: 22 },
        'Lotus Emeya': { battery: 102, range: 610, consumption: 19 },
        'Toyota bZ4X': { battery: 71, range: 516, consumption: 17 },
        'Toyota Proace Electric': { battery: 75, range: 330, consumption: 25 },
        'Lexus UX 300e': { battery: 72, range: 450, consumption: 16 },
        'Lexus RZ 450e': { battery: 71, range: 440, consumption: 17 },
        'Subaru Solterra': { battery: 71, range: 466, consumption: 17 },
        'Mazda MX-30': { battery: 35, range: 200, consumption: 19 },
        'Honda e': { battery: 35, range: 222, consumption: 17 },
        'Honda e:Ny1': { battery: 68, range: 412, consumption: 16 },
        'Jaguar I-Pace': { battery: 90, range: 470, consumption: 22 },
        'Fisker Ocean': { battery: 100, range: 630, consumption: 19 },
        'Rivian R1T': { battery: 135, range: 500, consumption: 27 },
        'Rivian R1S': { battery: 135, range: 480, consumption: 28 },
        'Lucid Air Pure': { battery: 88, range: 676, consumption: 15 },
        'Lucid Air Touring': { battery: 92, range: 685, consumption: 16 },
        'Lucid Air Grand Touring': { battery: 112, range: 819, consumption: 17 },
        'VinFast VF 8': { battery: 87, range: 471, consumption: 20 },
        'VinFast VF 9': { battery: 123, range: 594, consumption: 23 }
    };

    // Inizializza select auto
    const carSelect = document.getElementById('carSelect');
    Object.keys(vehicles).forEach(car => {
        const option = document.createElement('option'); option.value = car; option.textContent = car; carSelect.appendChild(option);
    });

    // ===== Mappa =====
    let map; let userMarker = null; let destinationMarker = null; let chargingMarkers = []; let startCoords = null; let endCoords = null;

    function initMap(){
        if (typeof L === 'undefined'){
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = `
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
                    <div style="text-align:center;color:white;">
                        <h2 style="margin-bottom:20px;">üó∫Ô∏è Mappa Italia</h2>
                        <div style="background:white;border-radius:12px;padding:20px;color:#333;">
                            <p style="margin-bottom:15px;">Stazioni di ricarica disponibili</p>
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;text-align:left;font-size:14px;">
                                <div>‚ö° Milano: 245 stazioni</div><div>‚ö° Roma: 189 stazioni</div>
                                <div>‚ö° Napoli: 98 stazioni</div><div>‚ö° Torino: 134 stazioni</div>
                                <div>‚ö° Bologna: 87 stazioni</div><div>‚ö° Firenze: 76 stazioni</div>
                            </div>
                            <div style="margin-top:20px;padding:15px;background:#f5f7fa;border-radius:8px;">
                                <strong>Percorso calcolato:</strong><br><span id="mapRoute">Seleziona partenza e destinazione</span>
                            </div>
                        </div>
                    </div>
                </div>`; return;
        }
        map = L.map('map').setView([41.9028, 12.4964], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
        showStations();
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initMap); else setTimeout(initMap, 100);

    // ===== Stazioni demo =====
    const chargingStations = [
        { name: "Tesla Supercharger Milano", lat: 45.4642, lng: 9.1900, type: "Tesla", power: 250, price: 0.55 },
        { name: "Ionity Milano Est", lat: 45.4854, lng: 9.2366, type: "Ionity", power: 350, price: 0.79 },
        { name: "Enel X Torino", lat: 45.0703, lng: 7.6869, type: "Enel X", power: 150, price: 0.60 },
        { name: "Fastned Verona", lat: 45.4384, lng: 10.9916, type: "Fastned", power: 300, price: 0.69 },
        { name: "Free2Move Venezia", lat: 45.4908, lng: 12.2351, type: "Free2Move", power: 100, price: 0.50 },
        { name: "Tesla Supercharger Roma", lat: 41.9028, lng: 12.4964, type: "Tesla", power: 250, price: 0.55 },
        { name: "Ionity Napoli", lat: 40.8518, lng: 14.2681, type: "Ionity", power: 350, price: 0.79 },
        { name: "Enel X Bari", lat: 41.1171, lng: 16.8719, type: "Enel X", power: 150, price: 0.60 },
        { name: "Tesla Supercharger Palermo", lat: 38.1157, lng: 13.3615, type: "Tesla", power: 250, price: 0.55 },
        { name: "Enel X Cagliari", lat: 39.2238, lng: 9.1217, type: "Enel X", power: 150, price: 0.60 }
    ];
    function getStationColor(type){ const colors={ 'Tesla':'#e73536','Ionity':'#0066ff','Enel X':'#00dc82','Fastned':'#ffaa00','Free2Move':'#7c3aed' }; return colors[type]||'#666'; }
    function showStations(){ if (typeof L==='undefined' || !map) return; chargingStations.forEach(station=>{ const icon=L.divIcon({className:'charging-icon', html:`<div style="background:${getStationColor(station.type)};width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:12px;box-shadow:0 2px 5px rgba(0,0,0,0.3);">‚ö°</div>`}); const marker=L.marker([station.lat, station.lng], {icon}).addTo(map); marker.bindPopup(`<strong>${station.name}</strong><br>Tipo: ${station.type}<br>Potenza: ${station.power}kW<br>Prezzo: ‚Ç¨${station.price}/kWh`); chargingMarkers.push(marker); }); }

    // ===== Batteria / Auto =====
    function updateBattery(value){
        const percentage = value + '%';
        document.getElementById('batteryFill').style.width = percentage;
        document.getElementById('batteryPercentage').textContent = percentage;
        const fill = document.getElementById('batteryFill');
        if (value < 20) fill.style.background = 'linear-gradient(90deg, #ff4757, #ff3838)';
        else if (value < 50) fill.style.background = 'linear-gradient(90deg, #ffa502, #ff7675)';
        else fill.style.background = 'linear-gradient(90deg, #00dc82, #00a86b)';
        updateBatteryInfo();
    }
    function updateBatteryInfo(){
        const selectedCar = document.getElementById('carSelect').value;
        const batteryLevel = document.getElementById('batterySlider').value;
        if (selectedCar && vehicles[selectedCar]){
            const vehicle = vehicles[selectedCar];
            const currentRange = Math.round((vehicle.range * batteryLevel) / 100);
            document.getElementById('rangeValue').textContent = currentRange + ' km';
        }
    }
    function searchCar(query){
        const select = document.getElementById('carSelect');
        const options = select.options;
        for (let i=0;i<options.length;i++){
            options[i].style.display = options[i].text.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
        }
    }

    // ===== Autocomplete citt√† migliorato =====
    const italianCities = [
      'Roma','Milano','Napoli','Torino','Palermo','Genova','Bologna','Firenze','Bari','Catania','Venezia','Verona','Messina','Padova','Trieste','Brescia','Parma','Prato','Modena','Reggio Calabria','Reggio Emilia','Perugia','Livorno','Ravenna','Cagliari','Foggia','Rimini','Salerno','Ferrara','Sassari','Latina','Giugliano in Campania','Monza','Siracusa','Pescara','Bergamo','Forl√¨','Trento','Vicenza','Terni','Bolzano','Novara','Piacenza','Ancona','Andria','Arezzo','Udine','Cesena','Lecce','Pesaro','Alessandria','Barletta','La Spezia','Pistoia','Pisa','Catanzaro','Brindisi','Torre del Greco','Como','Lucca','Treviso','Busto Arsizio','Varese','Caserta','Guidonia Montecelio','Marsala','Cosenza','Grosseto','Asti','Cremona','Pavia','Taranto','Viterbo','Fiumicino','Casoria','Savona','Vigevano','Legnano','Pozzuoli','Matera','Benevento','Castellammare di Stabia','Afragola','Vittoria','Crotone','Pomezia','Caltanissetta','Carrara','Viareggio','Fano','Ragusa','Imola','Trapani','Castelfranco Veneto','Lamezia Terme','Altamura','Molfetta','Agrigento','Velletri','Siena'
    ];
    const debouncers = {}; function debounce(key, fn, wait=250){ clearTimeout(debouncers[key]); debouncers[key] = setTimeout(fn, wait); }
    function normalize(str){ return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }
    function highlightMatch(text, query){ const nText=normalize(text), nQuery=normalize(query); const idx=nText.indexOf(nQuery); if(idx<0) return text; return text.substring(0,idx) + '<b>' + text.substring(idx, idx+query.length) + '</b>' + text.substring(idx+query.length); }
    function fuzzyFilter(list, query){ const q=normalize(query); return list.map(name=>{ const n=normalize(name); const score = n.startsWith(q) ? 0 : (n.includes(q) ? 1 : 2); return {name, score};}).filter(x=>x.score<2).sort((a,b)=>a.score-b.score).slice(0,10).map(x=>x.name); }
    function renderSuggestions(type, items, query){ const box=document.getElementById(type+'Suggestions'); if(!items||!items.length){ box.classList.remove('active'); box.innerHTML=''; return; } box.innerHTML = items.map((it,i)=>{ const label=it.label||it.display_name||it.name||it; const meta=it.meta||''; return `<div class="suggestion-item" data-index="${i}" data-type="${type}" onclick='selectLocationByIndex(${i},"${type}")'><div>${highlightMatch(label, query)}</div>${meta?`<div class="suggestion-meta">${meta}</div>`:''}</div>`; }).join(''); box.classList.add('active'); }
    const nominatimCache = new Map();
    async function nominatimSearch(query){
      const key='it:'+query.trim(); if(nominatimCache.has(key)) return nominatimCache.get(key);
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('q', query); url.searchParams.set('format','jsonv2'); url.searchParams.set('addressdetails','1'); url.searchParams.set('limit','8'); url.searchParams.set('accept-language','it'); url.searchParams.set('countrycodes','it');
      try{ const res=await fetch(url.toString(),{headers:{'Accept':'application/json'}}); if(!res.ok) throw new Error('Nominatim '+res.status); const data=await res.json(); const items=data.filter(d=>['city','town','village','hamlet','neighbourhood','suburb'].includes(d.type)||d.class==='place').map(d=>{ const a=d.address||{}; const city=a.city||a.town||a.village||a.hamlet||a.municipality||d.display_name; const prov=a.county||a.province||a.state_district||''; const reg=a.state||''; const label=city; const meta=[prov, reg, a.country].filter(Boolean).join(' ‚Ä¢ '); return {label, meta, lat:+d.lat, lon:+d.lon, raw:d}; }); nominatimCache.set(key, items); return items; }catch(e){ console.warn('Nominatim fallback:', e.message); return []; }
    }
    function searchLocation(query, type){
      const q=query.trim(); const box=document.getElementById(type+'Suggestions'); if(q.length<2){ box.classList.remove('active'); box.innerHTML=''; return; }
      const offline=fuzzyFilter(italianCities, q).map(name=>({label:name, meta:'Italia'})); renderSuggestions(type, offline, q);
      debounce('geo:'+type, async ()=>{ const online=await nominatimSearch(q); if(online.length){ renderSuggestions(type, online, q); window.__lastResults=window.__lastResults||{}; window.__lastResults[type]=online; } else { window.__lastResults=window.__lastResults||{}; window.__lastResults[type]=offline.map(o=>({label:o.label, lat:null, lon:null})); } }, 300);
    }
    function selectLocationByIndex(index, type){
      const results=(window.__lastResults && window.__lastResults[type]) || []; const box=document.getElementById(type+'Suggestions'); const input=document.getElementById(type+'Location'); let item=results[index]; if(!item){ const el=box.querySelector(`.suggestion-item[data-index="${index}"] div:first-child`); if(el){ item={label:el.textContent, lat:null, lon:null}; } }
      if(!item) return; input.value=item.label; box.classList.remove('active'); box.innerHTML=''; if(item.lat==null||item.lon==null){ nominatimSearch(item.label).then(list=>{ const best=list[0]; if(best){ setCoords(type, best.lat, best.lon, best.label); } else { setCoords(type, null, null, item.label); } }); } else { setCoords(type, item.lat, item.lon, item.label); }
    }
    function navSuggestions(e, type){ const box=document.getElementById(type+'Suggestions'); const items=Array.from(box.querySelectorAll('.suggestion-item')); if(!items.length) return; const current=items.findIndex(it=>it.classList.contains('active')); if(e.key==='ArrowDown'){ e.preventDefault(); const next=(current+1)%items.length; items.forEach(i=>i.classList.remove('active')); items[next].classList.add('active'); items[next].scrollIntoView({block:'nearest'}); } else if(e.key==='ArrowUp'){ e.preventDefault(); const prev=(current<=0?items.length-1:current-1); items.forEach(i=>i.classList.remove('active')); items[prev].classList.add('active'); items[prev].scrollIntoView({block:'nearest'}); } else if(e.key==='Enter'){ e.preventDefault(); const idx=current>=0?current:0; selectLocationByIndex(idx, type); } else if(e.key==='Escape'){ box.classList.remove('active'); box.innerHTML=''; } }
    function setCoords(type, lat, lon, label){
      if(typeof L==='undefined' || !map){ const mapRoute=document.getElementById('mapRoute'); if(mapRoute){ const start=document.getElementById('startLocation').value; const end=document.getElementById('endLocation').value; if(start && end) mapRoute.innerHTML = `<strong>${start}</strong> ‚Üí <strong>${end}</strong>`; } }
      else if(lat!=null && lon!=null){ const coords=[lat, lon]; if(type==='start'){ if(userMarker) map.removeLayer(userMarker); userMarker=L.marker(coords,{ icon:L.divIcon({className:'user-marker', html:'<div style="background:#00dc82;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,.3)"></div>'}) }).addTo(map); startCoords={lat, lon}; } else { if(destinationMarker) map.removeLayer(destinationMarker); destinationMarker=L.marker(coords,{ icon:L.divIcon({className:'dest-marker', html:'<div style="background:#ff4757;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,.3)"></div>'}) }).addTo(map); endCoords={lat, lon}; } map.setView(coords, 10); }
    }

    // ===== GPS + Reverse Geocoding =====
    async function useGPS(){
      if(!navigator.geolocation) return alert('Geolocalizzazione non supportata');
      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude; let label='Posizione attuale';
        try{ const url=`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=jsonv2&accept-language=it&addressdetails=1`; const res=await fetch(url,{headers:{'Accept':'application/json'}}); if(res.ok){ const j=await res.json(); const a=j.address||{}; label=a.city||a.town||a.village||a.municipality||j.display_name||label; } }catch{}
        const input=document.getElementById('startLocation'); input.value=label; setCoords('start', lat, lon, label);
      }, _=>alert('Impossibile ottenere la posizione GPS'), {enableHighAccuracy:true, timeout:10000});
    }

    // ===== Percorso (simulato per ora) =====
    async function ensureCoordsFromInput(type){
      const input=document.getElementById(type+'Location').value.trim(); if(!input) return null; if(type==='start' && startCoords) return startCoords; if(type==='end' && endCoords) return endCoords; const list=await nominatimSearch(input); const best=list[0]; if(best){ setCoords(type, best.lat, best.lon, best.label); return {lat:best.lat, lon:best.lon}; } return null; }

    async function calculateRoute(){
      const startTxt=document.getElementById('startLocation').value.trim();
      const endTxt=document.getElementById('endLocation').value.trim();
      const selectedCar=document.getElementById('carSelect').value;
      if(!startTxt || !endTxt || !selectedCar){ alert('Compila tutti i campi richiesti'); return; }
      document.getElementById('loading').classList.add('active');
      const s=await ensureCoordsFromInput('start'); const e=await ensureCoordsFromInput('end');
      setTimeout(()=>{
        document.getElementById('loading').classList.remove('active');
        const routeInfo=document.getElementById('routeInfo'); routeInfo.classList.add('active');
        const distance=Math.floor(Math.random()*400)+200; // placeholder
        const time=Math.floor(distance/100*60);
        const stops=Math.ceil(distance/300);
        const cost=(distance*0.15).toFixed(2);
        document.getElementById('totalDistance').textContent = distance + ' km';
        document.getElementById('travelTime').textContent = Math.floor(time/60) + 'h ' + (time%60) + 'min';
        document.getElementById('chargingStops').textContent = stops;
        document.getElementById('estimatedCost').textContent = '‚Ç¨' + cost;
        showRecommendedStations();
      }, 700);
    }

    function showRecommendedStations(){
      const stationList=document.getElementById('stationList');
      stationList.innerHTML='<h3 style="margin-bottom: 15px;">Stazioni consigliate lungo il percorso</h3>';
      const recommended=chargingStations.slice(0,3);
      recommended.forEach((station,i)=>{
        const card=document.createElement('div'); card.className='station-card';
        card.innerHTML = `
          <div class="station-header">
            <span class="station-name">${i+1}. ${station.name}</span>
            <span class="station-type">${station.type}</span>
          </div>
          <div class="station-details">
            <div>‚ö° ${station.power}kW</div>
            <div>üí∞ ‚Ç¨${station.price}/kWh</div>
            <div>üìç ${Math.floor(Math.random()*100)+50} km</div>
            <div>‚è±Ô∏è ${Math.floor(Math.random()*20)+10} min</div>
          </div>`;
        stationList.appendChild(card);
      });
    }

    // Chiudi suggerimenti cliccando fuori
    document.addEventListener('click', e => { if(!e.target.closest('.search-container')){ document.querySelectorAll('.search-suggestions').forEach(el=>el.classList.remove('active')); } });
</script>

</body>
</html>
